import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma'; // V√©rifie que ce chemin correspond bien √† l'emplacement de ton instance Prisma, souvent '@/lib/prisma' ou '@/lib/db'

// Note¬†: Cal.com peut envoyer une signature pour la s√©curit√©.
// Ici, on v√©rifie uniquement le type d'√©v√©nement (trigger).

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { triggerEvent, payload } = body;

    // On ne s'int√©resse qu'aux nouvelles r√©servations
    if (triggerEvent !== 'BOOKING_CREATED') {
      return NextResponse.json({ message: 'Ignored event' }, { status: 200 });
    }

    console.log("üîî Webhook Cal.com re√ßu pour :", payload.organizer.email);

    // 1. Trouver l'artiste dans TA base de donn√©es via son email
    // (L'email utilis√© pour configurer le compte Cal.com)
    const artistUser = await prisma.user.findUnique({
      where: {
        email: payload.organizer.email, 
      },
      include: {
        artist: true // On inclut le profil artiste si besoin de l'ID artiste sp√©cifique
      }
    });

    if (!artistUser) {
      console.error("‚ùå Artiste non trouv√© pour l'email:", payload.organizer.email);
      return NextResponse.json({ message: 'Artist not found' }, { status: 404 });
    }

    // 2. Cr√©er la r√©servation dans TA table Booking
    // ADAPTE LES CHAMPS ICI selon ton schema.prisma exact !
    const newBooking = await prisma.booking.create({
      data: {
        // Liaison avec l'artiste (selon comment ton schema est fait, soit userId soit artistId)
        artistId: artistUser.artist?.id || artistUser.id, 
        
        // Dates (Cal.com envoie des ISO strings, Prisma les convertit en Date)
        startTime: new Date(payload.startTime),
        endTime: new Date(payload.endTime),
        
        // Infos Client
        clientName: payload.attendees[0].name || 'Client Inconnu',
        clientEmail: payload.attendees[0].email || 'No Email',
        
        // Infos Projet
        projectName: payload.title || 'R√©servation Cal.com',
        description: payload.description || 'Import√© depuis Cal.com',
        
        // Statut
        status: 'CONFIRMED', // On consid√®re que si c'est dans Cal, c'est valid√©
        source: 'CAL_COM',   // Utile pour savoir d'o√π √ßa vient (si tu as ce champ)
      },
    });

    console.log("‚úÖ R√©servation cr√©√©e dans InkFlow :", newBooking.id);

    return NextResponse.json({ success: true });

  } catch (error) {
    console.error("‚ùå Erreur Webhook:", error);
    return NextResponse.json({ message: 'Internal Server Error' }, { status: 500 });
  }
}